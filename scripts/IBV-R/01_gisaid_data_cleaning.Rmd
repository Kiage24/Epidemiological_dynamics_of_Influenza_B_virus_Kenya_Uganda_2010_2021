---
title: "IBV"
output: html_document
date: "2023-03-01"
---

``````{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```



```{r}

#Load in the required libraries for cleaning the dataset

library(Biostrings)
library(dplyr)
library(tidyr)
library(phylotools)
library(readxl)
```

```{r Read in fasta file}

vic_gisaid_data <- readDNAStringSet("~/Desktop/Msc/data/gisaid/victoria_complete.fa")
yam_gisaid_data <- readDNAStringSet("~/Desktop/Msc/data/gisaid/yamagata_complete.fa")
festus_gisaid_data <- readDNAStringSet("~/Desktop/flub_msc/data/gisaid/Festus/gisaid_epiflu_sequence.fasta")
```



```{r}
#Create a dataframe containing the sequences

vic_gisaid_df <- as.data.frame(vic_gisaid_data)
yam_gisaid_df <- as.data.frame(yam_gisaid_data)
festus_gisaid_df <- as.data.frame(festus_gisaid_data)

#Extract the names of sequences and generate a dataframe
vic_gisaid_names <- names(vic_gisaid_data)
vic_gisaid_names_df <- as.data.frame(vic_gisaid_names)
festus_gisaid_names <- names(festus_gisaid_data) 
festus_gisaid_names_df <- as.data.frame(festus_gisaid_names)

yam_gisaid_names <- names(yam_gisaid_data)
yam_gisaid_names_df <- as.data.frame(yam_gisaid_names)

#Bind the two dataframes together

vic_gisaid <- cbind(vic_gisaid_names_df,vic_gisaid_df)
colnames(vic_gisaid) <- c('gisaid_names','sequences')

yam_gisaid <- cbind(yam_gisaid_names_df,yam_gisaid_df)
colnames(yam_gisaid) <- c('gisaid_names','sequences')

festus_gisaid <- cbind(festus_gisaid_names_df, festus_gisaid_df)
colnames(festus_gisaid) <- c('gisaid_names','sequences')
```



```{r}
#Remove duplicated entries

vic_gisaid <- vic_gisaid %>% distinct(gisaid_names, .keep_all = TRUE) 
yam_gisaid <- yam_gisaid %>% distinct(gisaid_names, .keep_all = TRUE)
festus_gisaid <- festus_gisaid %>% distinct(gisaid_names, .keep_all = TRUE)
```



```{r}

#Split the gisaid_names column

vic_gisaid <- vic_gisaid %>% separate(gisaid_names, c('isolate_name','isolate_id', 'lineage', 'segment','collection_date'), sep = '\\|')
vic_gisaid <- vic_gisaid %>% drop_na(collection_date) %>%
                             separate(collection_date, c('year','month', 'day'), sep = "-") %>%
                             separate(isolate_name, c('subtype','name'), sep = "/") %>%
                             unite(isolate_name, c(subtype, name), sep = "/")

#Clean the names column

vic_gisaid$isolate_name <- gsub("'", "_", vic_gisaid$isolate_name)
vic_gisaid$isolate_name <- gsub("._", "_", vic_gisaid$isolate_name)

yam_gisaid <- yam_gisaid %>% separate(gisaid_names, c('isolate_name','isolate_id','lineage','segment','collection_date'), sep = '\\|')
yam_gisaid <- yam_gisaid %>% drop_na(collection_date) %>%
                             separate(collection_date, c('year','month', 'day'), sep = "-") %>%
                             separate(isolate_name, c('subtype','name'), sep = "/") %>%
                             unite(isolate_name, c(subtype, name), sep = "/")
#Clean the names column

yam_gisaid$isolate_name <- gsub("'", "_", yam_gisaid$isolate_name)
yam_gisaid$isolate_name <- gsub("-", "_", yam_gisaid$isolate_name)
yam_gisaid$isolate_name <- gsub("._", "_", yam_gisaid$isolate_name)

festus_gisaid <- festus_gisaid %>% separate(gisaid_names, c('isolate_name','isolate_id','lineage','segment','collection_date'), sep = '\\|')

```



```{r}

#Read in the metadata
vic_gisaid_metadata <- read_xls('~/Desktop/Msc/data/gisaid/victoria_metadata.xls')
yam_gisaid_metadata <- read_xls('~/Desktop/Msc/data/gisaid/yamagata_metadata.xls')

#subset the location column to obtain country 
vic_gisaid_metadata <- vic_gisaid_metadata %>% separate(Location, c('continent', 'country'), sep = '/')
yam_gisaid_metadata <- yam_gisaid_metadata %>% separate(Location, c('continent', 'country'), sep = '/')


#join the country and continent columns to the gisaid dataframe by isolate id column
colnames(vic_gisaid_metadata) <- gsub('Isolate_Id', 'isolate_id', colnames(vic_gisaid_metadata))
colnames(yam_gisaid_metadata) <- gsub('Isolate_Id', 'isolate_id', colnames(yam_gisaid_metadata))

vic_gisaid <- vic_gisaid %>% left_join(vic_gisaid_metadata %>% select('isolate_id', 'continent', 'country'), by='isolate_id')
yam_gisaid <- yam_gisaid %>% left_join(yam_gisaid_metadata %>% select('isolate_id', 'continent', 'country'), by='isolate_id')

vic_gisaid_HA <- subset(vic_gisaid , segment == "HA")
yam_gisaid_HA <- subset(yam_gisaid , segment == "HA")


```



```{r}

#Remove influenza A sequences

vic_gisaid <- vic_gisaid %>%
          filter(grepl('^B', isolate_name))
yam_gisaid <- yam_gisaid %>%
          filter(grepl('^B', isolate_name))

festus_gisaid <- festus_gisaid %>%
          filter(grepl('^B', isolate_name))



#Check if each sample has 8 segments

vic_gisaid_complete <- vic_gisaid %>% group_by(isolate_name, isolate_id) %>%
                summarise(count= n())

yam_gisaid_complete <- yam_gisaid %>% group_by(isolate_name, isolate_id) %>%
                summarise(count= n())

festus_gisaid_complete <- festus_gisaid %>% group_by(isolate_name, isolate_id) %>%
                summarise(count= n())

```



```{r Obtain continent information}
vic_global_metadata <-  subset(vic_gisaid,segment == 'HA')
write.csv(vic_global_metadata, "~/Desktop/flub_msc/global/DOCS/vic_global_metadata.csv")

yam_global_metadata <-  subset(yam_gisaid,segment == 'HA')
write.csv(yam_global_metadata, "~/Desktop/flub_msc/global/DOCS/yam_global_metadata.csv")

```



```{r}

#Subsample the vic dataset

subsample <- function (subsample_continent, subsample_year, subsample_month) {
  gisaid1 <- filter(yam_gisaid_HA, as.numeric(year) == subsample_year & continent == subsample_continent & as.numeric(month) == subsample_month)
  num_rows <- nrow(gisaid1)
  num_samples <- min(num_rows, 10)
  
  if (num_samples > 0) {
    data_subsample <- sample(gisaid1$isolate_id, num_samples)
    dataset_subsampled <- yam_gisaid_HA[yam_gisaid_HA$isolate_id %in% data_subsample, ]
    return(dataset_subsampled)
  } else {
    return(NULL)  # Return NULL if there are no samples to subsample
  }
}

continents <- c("Africa ", "Europe ", "Asia ", "Oceania ", "South America ", "North America ")
years <- c(2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022)
months <- c(01, 02, 03, 04, 05, 06, 07, 08, 09, 10, 11, 12)

writeFasta <- function(data, filename) {
  fastaLines <- c()
  for (rowNum in 1:nrow(data)) {
    fastaLines <- c(fastaLines, as.character(paste(">", data[rowNum, "header"], sep = "")))
    fastaLines <- c(fastaLines, as.character(data[rowNum, "sequences"]))
  }
  fileConn <- file(filename)
  writeLines(fastaLines, fileConn)
  close(fileConn)
}

# Assuming vic_gisaid dataset is loaded or generated correctly

for (continent in continents) {
  for (year in years) {
    for (month in months) {
      # Call your subsample function with the current continent and year
      subsample_data <- subsample(continent, year, month)
      
      if (!is.null(subsample_data)) {
        subsample_data <- unite(subsample_data, collection_date, c(year, month, day), sep = "-")
        subsample_data <- unite(subsample_data, header, c(isolate_name, isolate_id, collection_date), sep = '/')
        
        file_name <- paste("~/Desktop/flub_msc/global/data/HA_yam_subset_gisaid/", continent, "_", year, month, ".fasta")
        writeFasta(subsample_data, file_name)
      }
    }
  }
}

```






```{r write festus data}

festus_gisaid <- festus_gisaid %>% separate(isolate_name, c("virus","location"))

festus_gisaid <- festus_gisaid %>% unite(isolate_name, c(virus,location), sep = "/")

festus_gisaid <- festus_gisaid %>% unite(phylogeny_name, c(isolate_name, isolate_id, collection_date), sep = "/")


festus_gisaid_NS <-  subset(festus_gisaid, segment == 'NS')

writeFasta<-function(data, filename){
  fastaLines = c()
  for (rowNum in 1:nrow(data)){
    fastaLines = c(fastaLines, as.character(paste(">", data[rowNum,"phylogeny_name"], sep = "")))
    fastaLines = c(fastaLines,as.character(data[rowNum,"sequences"]))
  }
  fileConn<-file(filename)
  writeLines(fastaLines, fileConn)
  close(fileConn)
}

writeFasta(festus_gisaid_NS, '~/Desktop/flub_msc/results/renamed/NS_renamed_festus.fa')


```


```{r clean the subsampled data}

#vic_subsampled <- readDNAStringSet("~/Desktop/Msc/data/gisaid/vic_subsampled.fa")
yam_subsampled <- readDNAStringSet("~/Desktop/Msc/data/gisaid/yam_subsampled.fa")

#Create a dataframe containing the sequences

#vic_subsampled_df <- as.data.frame(vic_subsampled)
yam_subsampled_df <- as.data.frame(yam_subsampled)

#Extract the names of sequences and generate a dataframe
#vic_subsampled_names <- names(vic_subsampled)
#vic_subsampled_names_df <- as.data.frame(vic_subsampled_names)

yam_subsampled_names <- names(yam_subsampled)
yam_subsampled_names_df <- as.data.frame(yam_subsampled_names)

#Bind the two dataframes together

#vic_subsample <- cbind(vic_subsampled_names_df,vic_subsampled_df)
#colnames(vic_subsample) <- c('gisaid_names','sequences')

yam_subsample <- cbind(yam_subsampled_names_df,yam_subsampled_df)
colnames(yam_subsample) <- c('gisaid_names','sequences')


#Split the gisaid_names column

#vic_subsample <- vic_subsample %>% separate(gisaid_names, c('isolate_name','isolate_id', 'country', 'lineage', 'segment','collection_date'), sep = '\\|')

HA_vicsubsampled <- subset(vic_subsample, segment == "HA")
NA_vicsubsampled <- subset(vic_subsample, segment == "NA")
PB1_vicsubsampled <- subset(vic_subsample, segment == "PA")
PB1_vicsubsampled <- subset(vic_subsample, segment == "PB1")
PB2_vicsubsampled <- subset(vic_subsample, segment == "PB2")
MP_vicsubsampled <- subset(vic_subsample, segment == "NP")
MP_vicsubsampled <- subset(vic_subsample, segment == "MP")
NA_vicsubsampled <- subset(vic_subsample, segment == "NS")

yam_subsample <- yam_subsample %>% separate(gisaid_names, c('isolate_name','isolate_id', 'country', 'lineage', 'segment','collection_date'), sep = '\\|')

HA_yamsubsampled <- subset(yam_subsample, segment == "HA")
NA_yamsubsampled <- subset(yam_subsample, segment == "NA")
PA_yamsubsampled <- subset(yam_subsample, segment == "PA")
PB1_yamsubsampled <- subset(yam_subsample, segment == "PB1")
PB2_yamsubsampled <- subset(yam_subsample, segment == "PB2")
NP_yamsubsampled <- subset(yam_subsample, segment == "NP")
MP_yamsubsampled <- subset(yam_subsample, segment == "MP")
NS_yamsubsampled <- subset(yam_subsample, segment == "NS")



writeFasta <- function(data, filename) {
  fastaLines <- c()
  for (rowNum in 1:nrow(data)) {
    fastaLines <- c(fastaLines, as.character(paste(">", data[rowNum, "header"], sep = "")))
    fastaLines <- c(fastaLines, as.character(data[rowNum, "sequences"]))
  }
  fileConn <- file(filename)
  writeLines(fastaLines, fileConn)
  close(fileConn)
}

NS_yamsubsampled <- unite(NS_yamsubsampled, header, c(isolate_name,country,segment, collection_date), sep = '|')
writeFasta(NS_yamsubsampled, "~/Desktop/Msc/data/gisaid/NS_yamsubsampled.fa")


#yam_subsample <- yam_subsample %>% separate(gisaid_names, c('isolate_name','isolate_id','lineage','segment','collection_date'), sep = '\\|')

```

```{r}
NS_renamed <- readDNAStringSet("~/Desktop/Msc/flub_results/renamed_yam/NS_renamed.fa")
NS_renamed_df <- as.data.frame(NS_renamed)

NS_renamed_names <- names(NS_renamed)
NS_renamed_names_df <- as.data.frame(NS_renamed_names)

NS_rename <- cbind(NS_renamed_names_df,NS_renamed_df)
colnames(NS_rename) <- c('header','sequences')

NS_rename_new <- NS_rename %>% filter(grepl("B/", header))  
NS_rename_new <- NS_rename_new %>% separate(header, c('isolate_name','collection_date', 'lineage', 'segment', 'clade'), sep = '\\|')
NS_rename_new <- NS_rename_new %>% unite(header, c(isolate_name, lineage, segment,clade, collection_date), sep = '|')
NS_samples <- NS_rename %>% filter(!grepl("B/", header))
NS_renamed <- bind_rows(NS_rename_new, NS_samples)

writeFasta <- function(data, filename) {
  fastaLines <- c()
  for (rowNum in 1:nrow(data)) {
    fastaLines <- c(fastaLines, as.character(paste(">", data[rowNum, "header"], sep = "")))
    fastaLines <- c(fastaLines, as.character(data[rowNum, "sequences"]))
  }
  fileConn <- file(filename)
  writeLines(fastaLines, fileConn)
  close(fileConn)
}

writeFasta(NS_renamed, "~/Desktop/Msc/flub_results/renamed_yam/NS_renamed.fa")

```


```{r}
NS_yamaln <- readDNAStringSet("~/Desktop/Msc/flub_results/aligned_global/NS_yamglobaledt.fa")
NS_yamaln_df <- as.data.frame(NS_yamaln)

NS_yamaln_names <- names(NS_yamaln)
NS_yamaln_names_df <- as.data.frame(NS_yamaln_names)

NS_yamalnd <- cbind(NS_yamaln_names_df,NS_yamaln_df)
colnames(NS_yamalnd) <- c('header','sequences')

NS_yamalnd <- NS_yamalnd %>% distinct(header, .keep_all = TRUE)
NS_yamalnd$header <- gsub(" ", "_", NS_yamalnd$header)

writeFasta <- function(data, filename) {
  fastaLines <- c()
  for (rowNum in 1:nrow(data)) {
    fastaLines <- c(fastaLines, as.character(paste(">", data[rowNum, "header"], sep = "")))
    fastaLines <- c(fastaLines, as.character(data[rowNum, "sequences"]))
  }
  fileConn <- file(filename)
  writeLines(fastaLines, fileConn)
  close(fileConn)
}

writeFasta(NS_yamalnd, "~/Desktop/Msc/flub_results/aligned_global/NS_yamedited.fa")
```


```{r}
# Read in the nextclade metadata
HAvic_nextclade_metadata <- readDNAStringSet("~/Desktop/Msc/flub_results/aligned_total/HA_vicglobal.fa")
HAyam_nextclade_metadata <- readDNAStringSet("~/Desktop/Msc/flub_results/aligned_total/HA_yamglobal.fa")

vic_labels <- names(HAvic_nextclade_metadata)
yam_labels <- names(HAyam_nextclade_metadata)
yam_df <- as.data.frame(yam_labels)

labels <- c(vic_labels, yam_labels)
labels_df <- as.data.frame(labels)
write_csv(labels_df, "~/Desktop/flub_msc/labels_global.csv")


HA_nextclade_metadata <- bind_rows(HAvic_nextclade_metadata, HAyam_nextclade_metadata)


#Obtain the sample metadata only
HA_ref_metadata <- HA_nextclade_metadata %>% filter(!grepl("^B/", seqName)) %>%
                      separate(seqName, c("location","virus","sample_id","collection_date"), sep = "/")


```



---
title: "treetime_dates"
author: "Brenda_Kiage"
date: "2023-06-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r Load the required libraries}
library(lubridate)
```


```{r generate tsv date files for genotyping datasets}

# Read in the tree from file

HA_tree <- read.tree("~/Desktop/Msc/flub_results/genotyping/iqtree/HAtreecln.nwk")
HA_tree$tip.label


#Create a metadata file with the year and location column
metadata <- HA_tree$tip.label
metadata_df <- as.data.frame(metadata)
rownames(metadata_df) <- metadata

#Separate the reference headers to obtain collection dates
references <- metadata_df[grepl("B/", metadata_df$metadata), ]
ref_df <- as.data.frame(references)
ref_df$references <- gsub("'", "", ref_df$references)
ref_df <- ref_df %>% separate(references, c("sample_id","Lineage", "segment", "clade", "collection_date"), sep = "\\|") %>% 
                     separate(collection_date, c("year", "month", "date"), sep = "-")
rownames(ref_df) <- references

#Separate the sample headers to obtain collection dates
samples <- metadata_df[!grepl("B/", metadata_df$metadata), ]
sample_df <- as.data.frame(samples)
sample_df$samples <- gsub("'", "", sample_df$samples)
sample_df <- sample_df %>% separate(samples, c("sample_id", "Location","collection_date"), sep = "\\|")%>% 
             separate(collection_date, c("year", "month", "date"), sep = "-")
rownames(sample_df) <- samples


#Bind the two datasets
mdata <- bind_rows(ref_df, sample_df)
mdata <- mdata[rownames(metadata_df), ]
mdata$label <- rownames(metadata_df)
mdata$Location <- as.factor(mdata$Location)
mdata$month[is.na(mdata$month)] <- "XX"
mdata$date[is.na(mdata$date)] <- "XX"

#Reunite the headers 
mdata <- mdata %>% unite("collection_date", c(year, month, date), sep = "-")
dates <- data.frame(mdata$label, mdata$collection_date)
colnames(dates) <- c("name", "collection_date")
dates$name <- gsub("'","", dates$name)

#Convert the collection dates into decimal format
#dates$collection_date <- decimal_date(ymd(dates$collection_date))

#Write to file
write_tsv(dates, "~/Desktop/Msc/flub_results/genotyping/treetime/HA_vicdatescln.tsv")


```

